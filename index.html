<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°å­—ç ´è¯‘ - å®æ—¶è§¦å‘ç‰ˆ</title>
    <style>
        :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; --bg: #f0f2f5; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; flex-direction: column; align-items: center; background: var(--bg); padding: 20px; margin: 0; }
        .main-layout { display: flex; gap: 20px; max-width: 1250px; width: 100%; flex-wrap: wrap; justify-content: center; align-items: flex-start; }
        
        /* é¢æ¿æ ·å¼ */
        .panel { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); height: 600px; display: flex; flex-direction: column; }
        h3 { margin-top: 0; font-size: 1.2rem; border-bottom: 2px solid #eee; padding-bottom: 10px; color: #333; display: flex; justify-content: space-between; align-items: center; }
        
        .left-panel { width: 300px; } /* é€šå…³å­˜æ¡£ */
        .center-panel { width: 400px; height: auto; min-height: 600px; } /* æ¸¸æˆç»ˆç«¯ */
        .right-panel { width: 280px; } /* æœ€ä½³çºªå½• */

        .scroll-area { flex: 1; overflow-y: auto; }
        
        /* å­˜æ¡£æ¡ç›® */
        .history-item { 
            position: relative; padding: 12px; border-bottom: 1px solid #f5f5f5; cursor: pointer; transition: 0.2s; border-radius: 6px; 
        }
        .history-item:hover { background: #f0f7ff; }
        .del-btn { 
            position: absolute; right: 8px; top: 8px; color: #bbb; cursor: pointer; padding: 2px 6px; font-size: 16px; font-weight: bold;
        }
        .del-btn:hover { color: var(--danger); background: #fee; border-radius: 4px; }
        
        /* è®¡æ—¶å™¨ä¸ç»Ÿè®¡ */
        .timer-display { font-size: 2.5rem; font-weight: bold; color: #95a5a6; text-align: center; font-family: 'Segoe UI', sans-serif; margin: 10px 0; }
        .timer-active { color: var(--primary); }
        .stats-box { margin-bottom: 1rem; color: #666; line-height: 1.6; font-size: 0.95rem; }
        
        /* ç”Ÿå‘½å‘¨æœŸæ•°å­—æ”¹ä¸ºæ™®é€šé¢œè‰² */
        .life-count { color: #333; font-weight: bold; font-size: inherit; }

        /* è¾“å…¥ä¸æŒ‰é’® */
        input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 1.5rem; letter-spacing: 4px; text-align: center; outline: none; transition: border-color 0.3s; font-family: inherit; }
        input:focus { border-color: var(--primary); }
        button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1.1rem; font-weight: bold; transition: 0.2s; font-family: inherit; }
        button:hover { background: #0056b3; transform: translateY(-1px); }
        
        /* å¼¹çª—æ ·å¼ */
        #details-modal { 
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 25px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 100; width: 90%; max-width: 420px; max-height: 80vh; overflow-y: auto;
        }
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 99; backdrop-filter: blur(2px); }
        
        .record-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .record-table tr:nth-child(even) { background: #fafafa; }
        .record-table td { padding: 12px 6px; border-bottom: 1px solid #eee; }
        .best-score { color: var(--success); font-weight: bold; }
    </style>
</head>
<body>

<div id="modal-overlay" onclick="closeModal()"></div>
<div id="details-modal">
    <h3 id="modal-title">ç ´è¯‘æµæ°´è¯¦æƒ…</h3>
    <div id="modal-content" style="font-family: inherit; line-height: 1.8; color: #444; background: #f9f9f9; padding: 15px; border-radius: 8px;"></div>
    <button onclick="closeModal()" style="margin-top:20px; background:#6c757d">å…³é—­</button>
</div>

<div class="main-layout">
    <div class="panel left-panel">
        <h3>ğŸ¾ é€šå…³å­˜æ¡£ <small style="font-weight:normal; font-size:11px; color:#999">ç‚¹æŒ‰çœ‹æµç¨‹</small></h3>
        <div class="scroll-area" id="pass-history-list"></div>
    </div>

    <div class="panel center-panel">
        <h3 style="border:none">æ•°å­—ç ´è¯‘æŒ‡ä»¤å°</h3>
        <div class="timer-display" id="timer">00:00.00</div>
        
        <div class="stats-box">
            å½“å‰è¿›åº¦: <strong>ç¬¬ <span id="current-len">1</span> å…³</strong><br>
            å¯†æ–‡é•¿åº¦: <strong><span id="target-len-info">1</span> ä½æ•°</strong><br>
            ç”Ÿå‘½ç‚¹æ•°: <span class="life-count" id="max-info">3</span> æ¬¡æœºä¼š
        </div>
        
        <input type="text" id="guessInput" placeholder="è¾“å…¥ä»£ç ..." autocomplete="off">
        <button onclick="checkGuess()">æäº¤éªŒè¯æŒ‡ä»¤</button>
        <div id="message" style="margin-top:15px; text-align:center; font-weight:500; min-height: 24px;"></div>

        <div id="historyLog" style="margin-top:20px; font-size: 0.85rem; color: #777; border-top: 1px solid #eee; padding-top:10px; overflow-y: auto;">
            <strong>å®æ—¶ä¿¡å·å†å²ï¼š</strong>
        </div>
    </div>

    <div class="panel right-panel">
        <h3>ğŸ† æœ€ä½³çºªå½• <small style="font-weight:normal; font-size:11px; color:#999">éš¾åº¦é™åº</small></h3>
        <div class="scroll-area">
            <table class="record-table">
                <tbody id="record-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const KEY_LEVEL = 'gn_v7_level', KEY_BEST = 'gn_v7_best', KEY_HISTORY = 'gn_v7_path';

    let currentLength = parseInt(localStorage.getItem(KEY_LEVEL)) || 1;
    let answer = "", attempts = 0, maxAttempts = 0, startTime, timerInterval, isTimerRunning = false, currentMs = 0;
    let currentStepLogs = []; 

    function formatTime(ms) {
        let m = Math.floor(ms / 60000), s = Math.floor((ms % 60000) / 1000), cs = Math.floor((ms % 1000) / 10);
        return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}.${cs.toString().padStart(2,'0')}`;
    }

    // å…³é”®å‡½æ•°ï¼šåªè¦è¾“å…¥å†…å®¹å°±å¼€å§‹è®¡æ—¶
    function startTimerOnce() {
        const inputVal = document.getElementById('guessInput').value;
        // åªæœ‰å½“è¾“å…¥æ¡†ä¸ä¸ºç©ºä¸”è®¡æ—¶å™¨æ²¡åœ¨è·‘æ—¶æ‰å¯åŠ¨
        if (inputVal.length > 0 && !isTimerRunning) {
            isTimerRunning = true;
            startTime = Date.now();
            document.getElementById('timer').classList.add('timer-active');
            document.getElementById('message').innerText = "è®¡æ—¶å¼€å§‹...";
            timerInterval = setInterval(() => {
                currentMs = Date.now() - startTime;
                document.getElementById('timer').innerText = formatTime(currentMs);
            }, 30);
        }
    }

    function initGame() {
        clearInterval(timerInterval);
        isTimerRunning = false;
        attempts = 0;
        answer = "";
        currentStepLogs = []; 
        localStorage.setItem(KEY_LEVEL, currentLength);
        
        maxAttempts = currentLength >= 4 ? Math.round(currentLength * 2.5) : 9;
        
        answer += Math.floor(Math.random() * 9 + 1).toString();
        for (let i = 1; i < currentLength; i++) answer += Math.floor(Math.random() * 10).toString();

        document.getElementById('timer').innerText = "00:00.00";
        document.getElementById('timer').classList.remove('timer-active');
        document.getElementById('current-len').innerText = currentLength;
        document.getElementById('target-len-info').innerText = currentLength;
        document.getElementById('max-info').innerText = maxAttempts;
        document.getElementById('historyLog').innerHTML = "<strong>å®æ—¶ä¿¡å·å†å²ï¼š</strong>";
        document.getElementById('message').innerText = "ç­‰å¾…è¾“å…¥...";
        document.getElementById('message').style.color = "#333";
        
        renderBestRecords();
        renderPassHistory();
    }

    function checkGuess() {
        const input = document.getElementById('guessInput');
        const val = input.value;
        const msgZone = document.getElementById('message');

        if (val.length !== currentLength || isNaN(val)) {
            msgZone.innerText = "âŒ æ ¼å¼é•¿åº¦é”™è¯¯";
            msgZone.style.color = "var(--danger)";
            return;
        }

        // æ­¤æ—¶å¦‚æœè®¡æ—¶å™¨è¿˜æ²¡è·‘ï¼ˆæ¯”å¦‚ç›´æ¥ç²˜è´´ï¼‰ï¼Œä¹Ÿç»™å®ƒè·‘èµ·æ¥
        if (!isTimerRunning) startTimerOnce();

        attempts++;
        let remaining = maxAttempts - attempts;
        document.getElementById('max-info').innerText = Math.max(0, remaining);

        let a = 0, b = 0, ansC = Array(10).fill(0), gueC = Array(10).fill(0), match = Array(10).fill(0);
        for (let i = 0; i < currentLength; i++) {
            ansC[answer[i]]++;
            if (answer[i] === val[i]) { a++; match[answer[i]]++; }
            else { gueC[val[i]]++; }
        }
        for (let i = 0; i < 10; i++) b += Math.min(gueC[i], ansC[i] - match[i]);

        const logTxt = `[${val}] -> ${a}âœ… ${b}âš ï¸`;
        currentStepLogs.push(logTxt);
        
        const line = document.createElement('div');
        line.style.padding = "2px 0";
        line.innerText = logTxt;
        document.getElementById('historyLog').prepend(line);

        if (a === currentLength) {
            clearInterval(timerInterval);
            saveWin(formatTime(currentMs), currentMs);
            msgZone.innerText = "âœ… åŒ¹é…æˆåŠŸï¼";
            msgZone.style.color = "var(--success)";
            currentLength++;
            setTimeout(initGame, 1500);
        } else if (remaining <= 0) {
            clearInterval(timerInterval);
            msgZone.innerText = "â˜¢ï¸ å¤±è´¥ï¼æ­£ç¡®ç : " + answer;
            msgZone.style.color = "var(--danger)";
            setTimeout(() => { 
                if(confirm("ç ´è¯‘å¤±è´¥ï¼Œæ˜¯å¦é‡ç½®å›1ä½é‡å¯ï¼Ÿ")) currentLength = 1;
                initGame();
            }, 500);
        }
        input.value = ""; input.focus();
    }

    function saveWin(timeStr, ms) {
        let bests = JSON.parse(localStorage.getItem(KEY_BEST) || "{}");
        if (!bests[currentLength] || ms < bests[currentLength].ms) {
            bests[currentLength] = { time: timeStr, ms: ms, tries: attempts };
            localStorage.setItem(KEY_BEST, JSON.stringify(bests));
        }
        let history = JSON.parse(localStorage.getItem(KEY_HISTORY) || "[]");
        history.unshift({
            len: currentLength, time: timeStr, tries: attempts, ans: answer,
            steps: [...currentStepLogs], date: new Date().toLocaleString()
        });
        localStorage.setItem(KEY_HISTORY, JSON.stringify(history));
    }

    function renderBestRecords() {
        const body = document.getElementById('record-body');
        let bests = JSON.parse(localStorage.getItem(KEY_BEST) || "{}");
        const sortedKeys = Object.keys(bests).sort((x, y) => parseInt(y) - parseInt(x));
        body.innerHTML = sortedKeys.map(k => 
            `<tr>
                <td><strong>${k}ä½</strong></td>
                <td class="best-score">${bests[k].time}</td>
                <td>${bests[k].tries}æ¬¡</td>
            </tr>`
        ).join('');
    }

    function renderPassHistory() {
        const list = document.getElementById('pass-history-list');
        let history = JSON.parse(localStorage.getItem(KEY_HISTORY) || "[]");
        if(history.length === 0) {
            list.innerHTML = `<div style="text-align:center; color:#ccc; margin-top:30px;">å°šæ— è®°å½•</div>`;
            return;
        }
        list.innerHTML = history.map((item, index) => `
            <div class="history-item" onclick="showDetails(${index})">
                <span class="del-btn" onclick="deleteHistory(event, ${index})">Ã—</span>
                <div style="font-weight:bold; color:var(--primary)">#${item.len}ä½ ç ´è¯‘æˆåŠŸ</div>
                <div style="font-size:0.75rem; color:#888;">è€—æ—¶: ${item.time} | å°è¯•: ${item.tries}æ¬¡</div>
            </div>
        `).join('');
    }

    function deleteHistory(event, index) {
        event.stopPropagation();
        if(confirm("ç¡®å®šç§»é™¤æ­¤æ¡å­˜æ¡£å—ï¼Ÿ")) {
            let history = JSON.parse(localStorage.getItem(KEY_HISTORY) || "[]");
            history.splice(index, 1);
            localStorage.setItem(KEY_HISTORY, JSON.stringify(history));
            renderPassHistory();
        }
    }

    function showDetails(index) {
        let history = JSON.parse(localStorage.getItem(KEY_HISTORY) || "[]");
        let item = history[index];
        document.getElementById('modal-title').innerText = `${item.len}ä½è¿‡ç¨‹å›æº¯`;
        document.getElementById('modal-content').innerHTML = `
            <div style="margin-bottom:15px; border-bottom:1px solid #ddd; padding-bottom:10px;">
                <b>æ—¥æœŸï¼š</b>${item.date}<br>
                <b>æ­£ç¡®ç­”æ¡ˆï¼š</b><span style="color:var(--success); font-weight:bold; letter-spacing:2px">${item.ans}</span><br>
                <b>ç”¨æ—¶ï¼š</b>${item.time}<br>
                <b>å°è¯•ï¼š</b>${item.tries}æ¬¡
            </div>
            <div style="font-size:0.95rem;">
                ${item.steps.map(s => `<div>${s}</div>`).join('')}
            </div>
        `;
        document.getElementById('modal-overlay').style.display = 'block';
        document.getElementById('details-modal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('modal-overlay').style.display = 'none';
        document.getElementById('details-modal').style.display = 'none';
    }

    // --- æ ¸å¿ƒäº‹ä»¶ç›‘å¬ ---
    // 1. è¾“å…¥å†…å®¹å³è§¦å‘è®¡æ—¶
    document.getElementById('guessInput').addEventListener('input', startTimerOnce);
    
    // 2. å›è½¦æäº¤
    document.getElementById('guessInput').addEventListener('keypress', (e) => { 
        if (e.key === 'Enter') checkGuess(); 
    });

    initGame();
</script>
</body>
</html>




